# mb <- read.csv('data/metabolism_genelist_total.csv',header = F)
# mb_result <- result[result$gene %in% mb$V1,]
mb_result <- result
g1 <- ggplot(mb_result, aes(logFC,`-Log10(adj.P)`,color=expression))+
geom_point(size=0.3)+
theme_classic()+
scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20),
legend.position = 'none'
) +
labs(title = j)+
theme(plot.title=element_text(hjust=0.5))
# 给5个上调和下调的基因标签
adata <- bind_rows(
mb_result %>%
filter(expression == 'Up-regulated') %>%
arrange(pVal,desc(abs(logFC)))%>%
head(10),
mb_result %>%
head(10),
# mb_result %>%
#   filter(logFC < 0) %>%
#   tail(5)
)
g1+geom_text_repel(data = adata,
aes(logFC, `-Log10(adj.P)`,label=gene),
size = 5)
ggsave(paste0('figure/',j,'_volcano_mb.pdf'),width = 8,height = 8,dpi=600)
write.csv(mb_result,quote = F, row.names = F,
file = paste0('./result/',j,'_nebula_result_mb.csv'),
)
# 导出上调和下调的差异代谢基因
up <- mb_result[mb_result$expression=='Up-regulated',]$gene
up <- as.data.frame(up)
write.table(up,paste0('./result/',j,'_up.csv'), col.names = F, row.names = F, quote = F)
}
for (j in cluster) {
counts <- read.csv(paste0('./data/',j,'_nebula_mb.csv'), row.names = 1)
mb <- read.csv('./data/metabolism_genelist_mb.csv',header = F)
# counts <- counts[rownames(counts) %in% mb$V1,]
count <- as.matrix(counts)
batch <- read.csv(paste0('./data/',j,'_nebula_batch.csv'), header = F)
label <- read.csv(paste0('./data/',j,'_nebula_label3.csv'), header = F)
df = model.matrix(~V1, data=label)
head(df)
data_g = group_cell(count=count,id=label$V1,pred=df)
re = nebula(data_g$count,data_g$id,pred=data_g$pred)
result <- re$summary
result <- result[,c(8,2,6)]
colnames(result) <- c('gene','logFC','pVal')
rownames(result) <- result$gene
result$adj.P <- p.adjust(result$pVal,method = 'BH')
result$'-Log10(adj.P)' <- -log10(result$adj.P)
# 由于这里差异分析是control比case，所以取个负值
result$logFC <- -result$logFC
result <-  result[order(result$logFC,decreasing = T),]
result$expression <- ifelse(result$logFC >= 1 & result$adj.P < 0.05,"Up-regulated",
ifelse(result$logFC <= -1 & result$adj.P < 0.05,"Down-regulated","NS."))
# 删除logFC很高，但NS的代谢基因
result <- result %>%
filter(!(abs(result$logFC) > 10 & result$adj.P > 0.05))
# g <- ggplot(result, aes(logFC,`-Log10(adj.P)`,color=expression))+
#   geom_point(size=0.1)+
#   theme_classic()+
#   scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
#   geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
#   geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
#   labs(title = j)+
#   theme(plot.title=element_text(hjust=0.5))
#
# ggsave(paste0('figure/',j,'_volcano.pdf'),width = 8,height = 8,dpi=600)
# write.csv(result,quote = F, row.names = F,
#           file = paste0('./result/',j,'_nebula_result_total.csv'),
# )
# mb <- read.csv('data/metabolism_genelist_total.csv',header = F)
# mb_result <- result[result$gene %in% mb$V1,]
mb_result <- result
g1 <- ggplot(mb_result, aes(logFC,`-Log10(adj.P)`,color=expression))+
geom_point(size=0.3)+
theme_classic()+
scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20),
legend.position = 'none'
) +
labs(title = j)+
theme(plot.title=element_text(hjust=0.5))
# 给5个上调和下调的基因标签
adata <- bind_rows(
mb_result %>%
filter(expression == 'Up-regulated') %>%
arrange(pVal,desc(abs(logFC)))%>%
head(10),
mb_result %>%
head(10),
# mb_result %>%
#   filter(logFC < 0) %>%
#   tail(5)
)
g1+geom_text_repel(data = adata,
aes(logFC, `-Log10(adj.P)`,label=gene),
size = 5)
ggsave(paste0('figure/',j,'_volcano_mb.pdf'),width = 8,height = 8,dpi=600)
write.csv(mb_result,quote = F, row.names = F,
file = paste0('./result/',j,'_nebula_result_mb.csv'),
)
# 导出上调和下调的差异代谢基因
up <- mb_result[mb_result$expression=='Up-regulated',]$gene
up <- as.data.frame(up)
write.table(up,paste0('./result/',j,'_up.csv'), col.names = F, row.names = F, quote = F)
}
for (j in cluster) {
counts <- read.csv(paste0('./data/',j,'_nebula_mb.csv'), row.names = 1)
# mb <- read.csv('./data/metabolism_genelist.csv',header = F)
# counts <- counts[rownames(counts) %in% mb$V1,]
count <- as.matrix(counts)
batch <- read.csv(paste0('./data/',j,'_nebula_batch.csv'), header = F)
label <- read.csv(paste0('./data/',j,'_nebula_label3.csv'), header = F)
df = model.matrix(~V1, data=label)
head(df)
data_g = group_cell(count=count,id=label$V1,pred=df)
re = nebula(data_g$count,data_g$id,pred=data_g$pred)
result <- re$summary
result <- result[,c(8,2,6)]
colnames(result) <- c('gene','logFC','pVal')
rownames(result) <- result$gene
result$adj.P <- p.adjust(result$pVal,method = 'BH')
result$'-Log10(adj.P)' <- -log10(result$adj.P)
# 由于这里差异分析是control比case，所以取个负值
result$logFC <- -result$logFC
result <-  result[order(result$logFC,decreasing = T),]
result$expression <- ifelse(result$logFC >= 1 & result$adj.P < 0.05,"Up-regulated",
ifelse(result$logFC <= -1 & result$adj.P < 0.05,"Down-regulated","NS."))
# 删除logFC很高，但NS的代谢基因
result <- result %>%
filter(!(abs(result$logFC) > 10 & result$adj.P > 0.05))
# g <- ggplot(result, aes(logFC,`-Log10(adj.P)`,color=expression))+
#   geom_point(size=0.1)+
#   theme_classic()+
#   scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
#   geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
#   geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
#   labs(title = j)+
#   theme(plot.title=element_text(hjust=0.5))
#
# ggsave(paste0('figure/',j,'_volcano.pdf'),width = 8,height = 8,dpi=600)
# write.csv(result,quote = F, row.names = F,
#           file = paste0('./result/',j,'_nebula_result_total.csv'),
# )
# mb <- read.csv('data/metabolism_genelist_total.csv',header = F)
# mb_result <- result[result$gene %in% mb$V1,]
mb_result <- result
g1 <- ggplot(mb_result, aes(logFC,`-Log10(adj.P)`,color=expression))+
geom_point(size=0.3)+
theme_classic()+
scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20),
legend.position = 'none'
) +
labs(title = j)+
theme(plot.title=element_text(hjust=0.5))
# 给5个上调和下调的基因标签
adata <- bind_rows(
mb_result %>%
filter(expression == 'Up-regulated') %>%
arrange(pVal,desc(abs(logFC)))%>%
head(10),
mb_result %>%
head(10),
# mb_result %>%
#   filter(logFC < 0) %>%
#   tail(5)
)
g1+geom_text_repel(data = adata,
aes(logFC, `-Log10(adj.P)`,label=gene),
size = 5)
ggsave(paste0('figure/',j,'_volcano_mb.pdf'),width = 8,height = 8,dpi=600)
write.csv(mb_result,quote = F, row.names = F,
file = paste0('./result/',j,'_nebula_result_mb.csv'),
)
# 导出上调和下调的差异代谢基因
up <- mb_result[mb_result$expression=='Up-regulated',]$gene
up <- as.data.frame(up)
write.table(up,paste0('./result/',j,'_up.csv'), col.names = F, row.names = F, quote = F)
}
theme_get()$text
font()
font_families()
library(showtext)
install.packages('showtext')
library(showtext)
library(showtext)
font_families()
cluster <- c('t_Bmem-CD27','t_pB-IGHG1','t_macro-MMP9')
library(nebula)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library(dplyr)
library(showtext)
#> Warning: package 'nebula' was built under R version 4.1.2
# input raw count matrix，note:do not normalize the data
setwd('/Users/liupeiwen/BC/New_analysis/2.Nebula/')
for (j in cluster) {
counts <- read.csv(paste0('./data/',j,'_nebula_mb.csv'), row.names = 1)
# mb <- read.csv('./data/metabolism_genelist.csv',header = F)
# counts <- counts[rownames(counts) %in% mb$V1,]
count <- as.matrix(counts)
batch <- read.csv(paste0('./data/',j,'_nebula_batch.csv'), header = F)
label <- read.csv(paste0('./data/',j,'_nebula_label3.csv'), header = F)
df = model.matrix(~V1, data=label)
head(df)
data_g = group_cell(count=count,id=label$V1,pred=df)
re = nebula(data_g$count,data_g$id,pred=data_g$pred)
result <- re$summary
result <- result[,c(8,2,6)]
colnames(result) <- c('gene','logFC','pVal')
rownames(result) <- result$gene
result$adj.P <- p.adjust(result$pVal,method = 'BH')
result$'-Log10(adj.P)' <- -log10(result$adj.P)
# 由于这里差异分析是control比case，所以取个负值
result$logFC <- -result$logFC
result <-  result[order(result$logFC,decreasing = T),]
result$expression <- ifelse(result$logFC >= 1 & result$adj.P < 0.05,"Up-regulated",
ifelse(result$logFC <= -1 & result$adj.P < 0.05,"Down-regulated","NS."))
# 删除logFC很高，但NS的代谢基因
result <- result %>%
filter(!(abs(result$logFC) > 10 & result$adj.P > 0.05))
# g <- ggplot(result, aes(logFC,`-Log10(adj.P)`,color=expression))+
#   geom_point(size=0.1)+
#   theme_classic()+
#   scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
#   geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
#   geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
#   labs(title = j)+
#   theme(plot.title=element_text(hjust=0.5))
#
# ggsave(paste0('figure/',j,'_volcano.pdf'),width = 8,height = 8,dpi=600)
# write.csv(result,quote = F, row.names = F,
#           file = paste0('./result/',j,'_nebula_result_total.csv'),
# )
# mb <- read.csv('data/metabolism_genelist_total.csv',header = F)
# mb_result <- result[result$gene %in% mb$V1,]
mb_result <- result
g1 <- ggplot(mb_result, aes(logFC,`-Log10(adj.P)`,color=expression))+
geom_point(size=0.3)+
theme_classic()+
scale_color_manual(values = c("Down-regulated"='red',"NS."='darkgrey',"Up-regulated"='blue'))+
geom_hline(yintercept=-log10(0.05),linetype=4, size=0.2)+
geom_vline(xintercept=c(-1,1),linetype=4, size=0.2)+
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20),
legend.position = 'none'
) +
labs(title = j)+
theme(plot.title=element_text(hjust=0.5))
# 给5个上调和下调的基因标签
adata <- bind_rows(
mb_result %>%
filter(expression == 'Up-regulated') %>%
arrange(pVal,desc(abs(logFC)))%>%
head(10),
mb_result %>%
head(10),
# mb_result %>%
#   filter(logFC < 0) %>%
#   tail(5)
)
g1+geom_text_repel(data = adata,
aes(logFC, `-Log10(adj.P)`,label=gene),
size = 5)
ggsave(paste0('figure/',j,'_volcano_mb.pdf'),width = 8,height = 8,dpi=600)
write.csv(mb_result,quote = F, row.names = F,
file = paste0('./result/',j,'_nebula_result_mb.csv'),
)
# 导出上调和下调的差异代谢基因
up <- mb_result[mb_result$expression=='Up-regulated',]$gene
up <- as.data.frame(up)
write.table(up,paste0('./result/',j,'_up.csv'), col.names = F, row.names = F, quote = F)
}
library(ggplot2)
library(tidyverse)
setwd('/Users/liupeiwen/BC/New_analysis/3.Enrichment/')
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t')
View(adata)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',col.names = 1)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',col.names = T)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',header = 1)
View(adata)
colnames(adata)
adata <- adata[c('description','enrichmentRatio', 'FDR')]
View(adata)
ggplot(adata,aes(x=decription,y=enrichmentRatio, fill=FDR)) +
geom_histogram()
ggplot(adata,aes(x=decription,y=enrichmentRatio, fill=FDR)) +
geom_col()
adata$enrichmentRatio <- as.numeric(adata$enrichmentRatio)
adata$FDR <- as.numeric(adata$FDR)
ggplot(adata,aes(x=decription,y=enrichmentRatio, fill=FDR)) +
geom_col()
View(adata)
View(adata)
ggplot(adata,aes(x=decription,y=enrichmentRatio, fill=FDR)) +
geom_point()
View(adata)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',header = 1)
View(adata)
setwd('/Users/liupeiwen/BC/New_analysis/3.Enrichment/')
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',header = 1)
View(adata)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',header = 1)
adata <- adata[c('description','enrichmentRatio', 'FDR')]
adata$enrichmentRatio <- as.numeric(adata$enrichmentRatio)
adata$FDR <- as.numeric(adata$FDR)
ggplot(adata,aes(x=decription,y=enrichmentRatio, fill=FDR)) +
geom_point()
View(adata)
ggplot(adata,aes(x=description,y=enrichmentRatio, fill=FDR)) +
geom_point()
ggplot(adata,aes(x=description,y=enrichmentRatio, fill=FDR)) +
geom_col()
ggplot(adata,aes(x=description,y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
ggplot(adata[order(adata$enrichmentRatio,decreasing = T),],aes(x=description,y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
View(adata)
adata <- adata[order(adata$enrichmentRatio,decreasing = T),]
adata$description <- factor(adata$description,levels = adata$description)
adata$description <- factor(adata$description,levels = as.vector(adata$description))
View(adata)
ggplot(adata[order(adata$enrichmentRatio,decreasing = T),],aes(x=description,y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
ggplot(adata,aes(x=reorder(description),y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
ggplot(adata,aes(x=reorder(description,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
View(adata)
adata <- read.table('./result/CD8-CXCL13.txt',sep = '\t',header = 1)
adata <- adata[c('description','enrichmentRatio', 'FDR')]
View(adata)
adata <- adata[c('geneset','enrichmentRatio', 'FDR')]
View(adata)
adata <- adata[c('geneSet','enrichmentRatio', 'FDR')]
View(adata)
adata$enrichmentRatio <- as.numeric(adata$enrichmentRatio)
adata$FDR <- as.numeric(adata$FDR)
adata$geneSet <- substring(adata$geneSet, 6,nchar(meta1$V11))
adata$geneSet <- substring(adata$geneSet, 6,nchar(adata$geneSet))
View(adata)
adata$geneSet <- tolower(adata$geneSet)
View(adata)
adata <- adata[order(adata$enrichmentRatio,decreasing = T),]
adata$description <- factor(adata$description,levels = as.vector(adata$description))
adata$geneSet  <- factor(adata$geneSet ,levels = as.vector(adata$geneSet ))
ggplot(adata,aes(x=geneSet,y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
View(adata)
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
theme_classic() +
coord_flip() +
scale_fill_distiller(palette = "Reds",direction = 1) +
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
theme_classic() +
coord_flip() +
scale_fill_distiller(palette = "Reds",direction = 1)
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
# scale_fill_distiller(palette = "Reds",direction = 1)
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Reds",direction = 1) +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Reds",direction = 0) +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Reds",direction = 2) +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Reds",direction = 0) +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Reds") +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip()
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20),
legend.position = 'none'
)
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20)
# legend.position = 'none'
)
adata$geneSet <- toupper(adata$geneSet)
adata <- adata[order(adata$enrichmentRatio,decreasing = T),]
adata$geneSet  <- factor(adata$geneSet ,levels = as.vector(adata$geneSet))
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_text(size=20)
# legend.position = 'none'
)
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y='none',
axis.title.x=element_text(size=20)
# legend.position = 'none'
)
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_text(size=20),
axis.title.x=element_blank()
# legend.position = 'none'
)
ggplot(adata,aes(x=reorder(geneSet,enrichmentRatio),y=enrichmentRatio, fill=FDR)) +
geom_col() +
scale_fill_distiller(palette = "Blues") +
theme_classic() +
coord_flip() +
theme(plot.title=element_text(hjust=0.5),
axis.text.x = element_text(size=15),
axis.text.y = element_text(size=15),
axis.title.y=element_blank(),
axis.title.x=element_text(size=20)
# legend.position = 'none'
)
